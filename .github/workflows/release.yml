name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      GRAFANA_ACCESS_POLICY_TOKEN: ${{ secrets.GRAFANA_ACCESS_POLICY_TOKEN }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22'
          cache: 'npm'

      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: '1.23'

      - run: go install github.com/magefile/mage@v1.15.0
      - run: npm ci
      - run: npm run build
      - run: mage -v buildAll

      - name: Sign plugin
        run: npx --yes @grafana/sign-plugin@3.2.1
        if: env.GRAFANA_ACCESS_POLICY_TOKEN != ''
        id: sign

      - name: Validate plugin
        run: |
          npx --yes @grafana/plugin-validator@0.37.1 \
            -sourceCodeUri file://. \
            dist/
        continue-on-error: true

      - name: Package plugin
        run: |
          cp -r dist chartcastr-posthog-datasource
          zip -r chartcastr-posthog-datasource-${{ github.ref_name }}.zip chartcastr-posthog-datasource/

      - name: Generate provenance attestation
        uses: actions/attest-build-provenance@db473fddc028af60658334401dc6fa3ffd8669fd # v2.3.0
        with:
          subject-path: chartcastr-posthog-datasource-${{ github.ref_name }}.zip

      - name: Generate checksum
        run: |
          sha1sum chartcastr-posthog-datasource-${{ github.ref_name }}.zip > chartcastr-posthog-datasource-${{ github.ref_name }}.zip.sha1
          md5sum chartcastr-posthog-datasource-${{ github.ref_name }}.zip > chartcastr-posthog-datasource-${{ github.ref_name }}.zip.md5

      - name: Create release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            chartcastr-posthog-datasource-${{ github.ref_name }}.zip
            chartcastr-posthog-datasource-${{ github.ref_name }}.zip.sha1
            chartcastr-posthog-datasource-${{ github.ref_name }}.zip.md5
          generate_release_notes: true
          body: |
            ## Installation

            ```bash
            grafana-cli \
              --pluginUrl https://github.com/mewc/posthog-grafana-plugin/releases/download/${{ github.ref_name }}/chartcastr-posthog-datasource-${{ github.ref_name }}.zip \
              plugins install chartcastr-posthog-datasource
            ```

            Then add `allow_loading_unsigned_plugins = chartcastr-posthog-datasource` to `grafana.ini` and restart Grafana.

            ## Checksums

            See `.sha1` and `.md5` files attached to this release.
