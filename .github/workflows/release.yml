name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      GRAFANA_ACCESS_POLICY_TOKEN: ${{ secrets.GRAFANA_ACCESS_POLICY_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - run: go install github.com/magefile/mage@latest
      - run: npm ci
      - run: npm run build
      - run: mage -v buildAll

      - name: Sign plugin
        run: >-
          npx --yes @grafana/sign-plugin@latest
          --rootUrls
          https://chartcastr.grafana.net,https://grafana-production-a86a4.up.railway.app,http://localhost:3000
        if: env.GRAFANA_ACCESS_POLICY_TOKEN != ''
        id: sign

      - name: Validate plugin
        run: |
          npx --yes @grafana/plugin-validator@latest \
            -sourceCodeUri file://. \
            dist/
        continue-on-error: true

      - name: Package plugin
        run: |
          cp -r dist mewc-posthog-datasource
          zip -r mewc-posthog-datasource-${{ github.ref_name }}.zip mewc-posthog-datasource/

      - name: Generate checksum
        run: |
          sha1sum mewc-posthog-datasource-${{ github.ref_name }}.zip > mewc-posthog-datasource-${{ github.ref_name }}.zip.sha1
          md5sum mewc-posthog-datasource-${{ github.ref_name }}.zip > mewc-posthog-datasource-${{ github.ref_name }}.zip.md5

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            mewc-posthog-datasource-${{ github.ref_name }}.zip
            mewc-posthog-datasource-${{ github.ref_name }}.zip.sha1
            mewc-posthog-datasource-${{ github.ref_name }}.zip.md5
          generate_release_notes: true
          body: |
            ## Installation

            ```bash
            grafana-cli \
              --pluginUrl https://github.com/mewc/posthog-grafana-plugin/releases/download/${{ github.ref_name }}/mewc-posthog-datasource-${{ github.ref_name }}.zip \
              plugins install mewc-posthog-datasource
            ```

            Then add `allow_loading_unsigned_plugins = mewc-posthog-datasource` to `grafana.ini` and restart Grafana.

            ## Checksums

            See `.sha1` and `.md5` files attached to this release.
